name: Update Domain Lists from Adguard

on:
  schedule:
    - cron: '0 0 * * *'  # 每天自动更新
  workflow_dispatch:  # 支持手动触发

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip
          pip3 install requests

      - name: Download Adguard DNS filter and process
        run: |
          # 下载 DnsFilter 列表
          curl -o filter.txt https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/main/filters/general/filter_1_DnsFilter/filter.txt

          # 直接执行 Python 脚本
          python3 -c "
import json
import re

suffix = []   # 精确域名（不含通配符）
wildcard = [] # 包含通配符的域名
ignore_ips = [] # 需要忽略的 IP 地址和域名

# 读取过滤列表
with open('filter.txt', 'r') as f:
    lines = f.readlines()

# 提取域名
for line in lines:
    line = line.strip()
    
    # 第一类：IP 地址（仅精确 IP，不处理通配符）
    if line.startswith('||') and re.match(r'^\|\|(\d{1,3}\.){3}\d{1,3}\^', line):
        ip = re.sub(r'^\|\|', '', line).strip().replace('^', '')
        ignore_ips.append(ip)
        continue

    # 第二类：正则表达式形式的 IP 地址
    if re.match(r'^\/\^.*\^\/$', line):
        ignore_ips.append(line)
        continue
    
    # 第三类：带通配符的 GIF 文件
    if re.match(r'^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\.*gif$', line):
        ignore_ips.append(line)
        continue
    
    # 第四类：以 @@ 开头的域名排除规则
    if line.startswith('@@'):
        domain = re.sub(r'^\@\@', '', line).strip().replace('^', '')
        ignore_ips.append(domain)
        continue

    # 精确域名（domain_suffix）
    if line.startswith('||'):
        domain = re.sub(r'^\|\|', '', line)
        domain = re.sub(r'\^.*$', '', domain).strip()
        if '*' not in domain:
            suffix.append(domain)
        else:
            wildcard.append(domain)

# 去重排序
suffix = sorted(set(suffix))
wildcard = sorted(set(wildcard))

# 保存 txt 文件
with open('suffix.txt', 'w') as f:
    f.write('\n'.join(suffix))
with open('wildcard.txt', 'w') as f:
    f.write('\n'.join(wildcard))

# 保存忽略的 IP 文件
with open('ignore_ips.txt', 'w') as f:
    f.write('\n'.join(ignore_ips))

print('suffix.txt, wildcard.txt, and ignore_ips.txt generated successfully!')
"

      - name: Commit & Push Changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add suffix.txt wildcard.txt ignore_ips.txt
          git commit -m "Auto update domain lists" || echo "No changes"
          git push
