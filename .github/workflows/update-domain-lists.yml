name: Update Domain Lists from Adguard

on:
  schedule:
    - cron: '0 0 * * *'  # 每天自动更新
  workflow_dispatch:  # 支持手动触发

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Python and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install python3 python3-pip
          pip3 install requests

      - name: Download Adguard DNS filter and process
        run: |
          # 下载 DnsFilter 列表
          curl -o filter.txt https://raw.githubusercontent.com/AdguardTeam/HostlistsRegistry/main/filters/general/filter_1_DnsFilter/filter.txt

          # 执行 Python 脚本处理过滤器
          python3 <<EOF
import json
import re
import requests

# 需要排除的特殊域名/IP
exclude_list = [
    "*.gif",
    "107.167.*.*",
    "121.204.246.*",
    "38.33.15.*",
    "67.21.92.*"
]

suffix = []   # 精确域名（不含通配符）
wildcard = [] # 包含通配符的域名

# 读取过滤列表
with open('filter.txt', 'r') as f:
    lines = f.readlines()

# 提取域名
for line in lines:
    line = line.strip()
    if not line or line.startswith("@@") or line.startswith("!"):
        continue
    if line.startswith("||"):
        domain = re.sub(r'^\|\|', '', line)
        domain = re.sub(r'\^.*$', '', domain).strip()
        if not domain:
            continue
        # 排除纯数字或 IP 开头的域名（仅对 domain_regex 适用）
        if re.match(r'^(\d{1,3}\.){1,3}\d{1,3}$', domain):  # 排除 IP 地址
            continue
        # 排除非法字符和长度问题
        if '..' in domain or domain.startswith('.') or domain.endswith('.') or len(domain) < 3:
            continue
        if re.search(r'[^a-zA-Z0-9\-.*]', domain):
            continue
        # 精确域名 (domain_suffix)
        if '*' not in domain:
            suffix.append(domain)
        else:
            wildcard.append(domain)

# 去重排序
suffix = sorted(set(suffix))
wildcard = sorted(set(wildcard))

# 保存 txt 文件
with open('suffix.txt', 'w') as f:
    f.write('\n'.join(suffix))
with open('wildcard.txt', 'w') as f:
    f.write('\n'.join(wildcard))

print("suffix.txt and wildcard.txt generated successfully!")
EOF

      - name: Commit & Push Changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          git add suffix.txt wildcard.txt
          git commit -m "Auto update domain lists" || echo "No changes"
          git push
